<!DOCTYPE html>
<html lang="tg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AviaTJ - Чиптаҳои арзон</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --blue: #007bff; --orange: #ff6d00; --bg: #f2f5f8; }
        body { font-family: sans-serif; background: var(--bg); margin: 0; padding-bottom: 70px; }
        .header { background: var(--blue); color: white; padding: 20px; text-align: center; border-radius: 0 0 25px 25px; position: relative; }
        .lang-switch { position: absolute; top: 10px; right: 10px; background: rgba(255,255,255,0.2); border: none; color: white; padding: 5px 10px; border-radius: 10px; }
        
        .search-box { background: white; margin: -20px 15px 20px; padding: 15px; border-radius: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .input-group { background: #f0f3f5; border-radius: 12px; padding: 10px; margin-bottom: 10px; display: flex; align-items: center; position: relative; }
        .input-group input { border: none; background: transparent; width: 100%; outline: none; margin-left: 10px; font-size: 16px; }
        
        /* Рӯйхати фурудгоҳҳо */
        .airport-dropdown { display: none; position: absolute; top: 100%; left: 0; width: 100%; background: white; z-index: 100; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .airport-item { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; }
        .airport-item:hover { background: #f8f9fa; }

        .btn-search { width: 100%; background: var(--orange); color: white; border: none; padding: 15px; border-radius: 12px; font-weight: bold; font-size: 16px; }

        .ticket { background: white; margin: 10px 15px; padding: 15px; border-radius: 15px; display: flex; justify-content: space-between; align-items: center; border-left: 5px solid var(--blue); }
        
        /* Modal */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); align-items: flex-end; }
        .modal-content { background: white; width: 100%; border-radius: 25px 25px 0 0; padding: 20px; box-sizing: border-box; }
        .btn-buy-now { background: var(--orange); color: white; width: 100%; display: block; text-align: center; padding: 15px; border-radius: 12px; text-decoration: none; font-weight: bold; margin-top: 15px; }
    </style>
</head>
<body>

<div class="header">
    <button class="lang-switch" onclick="toggleLang()">RU/TJ</button>
    <h1 id="title">Ҷустуҷӯи чипта</h1>
</div>

<div class="search-box">
    <div class="input-group">
        <i class="fa-solid fa-plane-departure"></i>
        <input type="text" id="fromInput" placeholder="Аз куҷо (DYU)" value="DYU">
    </div>
    
    <div class="input-group">
        <i class="fa-solid fa-plane-arrival"></i>
        <input type="text" id="toInput" placeholder="Ба куҷо (Масал: Москва)" oninput="checkMoscow(this.value)">
        <div id="moscowAirports" class="airport-dropdown">
            <div class="airport-item" onclick="selectAirport('VKO')">VKO — Внуково</div>
            <div class="airport-item" onclick="selectAirport('DME')">DME — Домодедово</div>
            <div class="airport-item" onclick="selectAirport('SVO')">SVO — Шереметьево</div>
            <div class="airport-item" onclick="selectAirport('ZIA')">ZIA — Жуковский</div>
        </div>
    </div>
    <button class="btn-search" onclick="performSearch()" id="searchBtn">ҶУСТУҶӮ</button>
</div>

<div id="results"></div>

<div id="detailModal" class="modal">
    <div class="modal-content">
        <h3 id="modalRoute"></h3>
        <p><b id="lblPrice">Нарх:</b> <span id="modalPrice"></span></p>
        <p><b id="lblType">Намуди рейс:</b> <span id="modalType"></span></p>
        <p><b id="lblBaggage">Бағоҷ:</b> 23кг (Тибқи тариф)</p>
        <hr>
        <a href="#" id="buyLink" class="btn-buy-now">ХАРИДАН (Aviasales)</a>
        <button onclick="closeModal()" style="width:100%; margin-top:10px; border:none; background:none; color:gray;">Пӯшидан</button>
    </div>
</div>

<script>
    let currentLang = 'tg';
    const dict = {
        tg: { title: "Ҷустуҷӯи чипта", search: "ҶУСТУҶӮ", price: "Нарх", type: "Намуди рейс", buy: "ХАРИДАН", direct: "Прямой рейс (Бе пасадка)", transit: "Бо пасадка (Пересадка)" },
        ru: { title: "Поиск билетов", search: "ПОИСК", price: "Цена", type: "Тип рейса", buy: "КУПИТЬ", direct: "Прямой рейс", transit: "С пересадкой" }
    };

    function toggleLang() {
        currentLang = currentLang === 'tg' ? 'ru' : 'tg';
        document.getElementById('title').innerText = dict[currentLang].title;
        document.getElementById('searchBtn').innerText = dict[currentLang].search;
        document.getElementById('lblPrice').innerText = dict[currentLang].price;
        document.getElementById('lblType').innerText = dict[currentLang].type;
    }

    function checkMoscow(val) {
        const dropdown = document.getElementById('moscowAirports');
        if(val.toLowerCase().includes('москва') || val.toUpperCase() === 'MOW') {
            dropdown.style.display = 'block';
        } else {
            dropdown.style.display = 'none';
        }
    }

    function selectAirport(code) {
        document.getElementById('toInput').value = code;
        document.getElementById('moscowAirports').style.display = 'none';
    }

    function performSearch() {
        const from = document.getElementById('fromInput').value;
        const to = document.getElementById('toInput').value;
        
        fetch('/search', {
            method: 'POST',
            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
            body: `from=${from}&to=${to}&lang=${currentLang}`
        })
        .then(res => res.json())
        .then(data => {
            let html = '';
            data.forEach(f => {
                const type = f.number_of_changes === 0 ? dict[currentLang].direct : dict[currentLang].transit;
                html += `
                <div class="ticket" onclick="showDetail('${f.origin}', '${f.destination}', '${f.value}', '${type}', '${f.buy_url}')">
                    <div>
                        <b>${f.origin} ➔ ${f.destination}</b><br>
                        <small>${f.depart_date}</small><br>
                        <span style="color: ${f.number_of_changes === 0 ? 'green' : 'orange'}">${type}</span>
                    </div>
                    <div style="text-align:right">
                        <div style="color:var(--blue); font-weight:bold">${f.value} TJS</div>
                        <small>Aviasales</small>
                    </div>
                </div>`;
            });
            document.getElementById('results').innerHTML = html || '<p style="text-align:center">Натиҷа ёфт нашуд</p>';
        });
    }

    function showDetail(from, to, price, type, link) {
        document.getElementById('modalRoute').innerText = from + " ➔ " + to;
        document.getElementById('modalPrice').innerText = price + " TJS";
        document.getElementById('modalType').innerText = type;
        document.getElementById('buyLink').href = link;
        document.getElementById('detailModal').style.display = 'flex';
    }

    function closeModal() { document.getElementById('detailModal').style.display = 'none'; }
</script>
</body>
</html>
